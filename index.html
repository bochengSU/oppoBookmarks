<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„æ›¸ç±¤ (v5.6 è§¸æ§é«”é©—å„ªåŒ–ç‰ˆ)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* è®“è§¸æ§æ“ä½œæ›´æµæš¢ï¼Œä½†å…è¨±é é¢æ»¾å‹• */
        html, body {
            -webkit-touch-callout: none; /* iOS Safari: ç¦ç”¨é•·æŒ‰é¸å–® */
            -webkit-user-select: none;   /* Safari/Chrome: ç¦ç”¨é¸å–æ–‡å­— */
            -moz-user-select: none;      /* Firefox */
            -ms-user-select: none;       /* IE/Edge */
            user-select: none;           /* æ¨™æº–èªæ³• */
        }
        /* Basic Reset & Font */
        body {
            font-family: 'Noto Sans TC', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
            line-height: 1.6;
        }
        .bookmark-container {
            max-width: 900px; margin: 20px auto; background-color: #ffffff; padding: 30px;
            border-radius: 12px; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
        }
        h1 {
            color: #2c3e50; text-align: center; margin-bottom: 20px; font-size: 2.2em;
            font-weight: 700; border-bottom: 2px solid #e0e0e0; padding-bottom: 15px;
        }
        .bookmark-list { list-style-type: none; padding-left: 0; margin: 0; }
        .bookmark-list ul { list-style-type: none; padding-left: 25px; margin: 5px 0; }
        .bookmark-item {
            position: relative;
            touch-action: manipulation;
            /* --- ä¿®æ”¹é» START (å¢åŠ é–“è·) --- */
            margin-bottom: 8px; /* çµ±ä¸€å¢åŠ æ‰€æœ‰é …ç›®çš„é–“è· */
            /* --- ä¿®æ”¹é» END --- */
        }
        #bookmark-list-root > .bookmark-item {
            margin-bottom: 12px; /* æ ¹ç›®éŒ„ä¸‹çš„é …ç›®é–“è·å¯ä»¥æ›´å¤§ä¸€äº› */
        }
        .bookmark-folder-details {
            margin-top: 10px; margin-bottom: 10px; border: 1px solid #e0e0e0;
            border-radius: 8px; background-color: #fcfcfc; overflow: hidden;
        }
        .bookmark-folder-details[open] > summary { background-color: #e8f0fe; border-bottom: 1px solid #d0d0d0; }
        .bookmark-folder-summary {
            font-weight: 700; cursor: pointer; padding: 12px 15px; background-color: #f0f8ff;
            color: #34495e; display: flex; align-items: center;
            transition: background-color 0.2s ease-in-out;
        }
        .bookmark-folder-summary:hover { background-color: #e8f0fe; }
        .bookmark-folder-summary h3 { margin: 0; font-size: 1.1em; display: inline-block; padding-left: 5px; }
        .bookmark-folder-details summary::-webkit-details-marker { display: none; }
        .bookmark-folder-details summary::before {
            content: "â–¶"; display: inline-block; margin-right: 10px;
            transition: transform 0.2s ease-in-out; font-size: 0.8em;
        }
        .bookmark-folder-details[open] summary::before { transform: rotate(90deg); }
        .bookmark-link {
            display: flex; align-items: center; padding: 8px 15px; text-decoration: none; color: #555;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            border: 1px solid transparent;
            border-radius: 8px; background-color: #fff;
        }
        .bookmark-item:hover .bookmark-link, .bookmark-item.touch-hover .bookmark-link {
             background-color: #eef5ff; color: #007bff; border-color: #cce5ff;
        }
        .bookmark-link:last-child { border-bottom: none; }
        .bookmark-icon {
            width: 16px; height: 16px; margin-right: 10px; vertical-align: middle;
            border-radius: 3px; flex-shrink: 0;
        }
        .item-controls {
            margin-left: auto; display: flex; align-items: center; gap: 8px; opacity: 0;
            transition: opacity 0.2s ease-in-out; padding-left: 10px;
        }
        .bookmark-item:hover .item-controls, .bookmark-item.touch-hover .item-controls,
        .bookmark-folder-summary:hover .item-controls, .bookmark-folder-summary.touch-hover .item-controls { opacity: 1; }
        .control-btn {
            background: none; border: none; cursor: pointer; font-size: 16px; padding: 2px 5px;
            border-radius: 4px; line-height: 1; color: #555;
        }
        .control-btn:hover { background-color: rgba(0, 0, 0, 0.1); color: #000; }
        .folder-actions {
            padding: 5px 15px 10px 40px; border-top: 1px solid #e0e0e0; background-color: #fdfdfd;
        }
        .add-btn {
            background-color: #e8f0fe; color: #34495e; border: 1px solid #d0d8e0;
            padding: 4px 10px; border-radius: 5px; cursor: pointer;
            font-size: 0.9em; margin-right: 10px;
        }
        .add-btn:hover { background-color: #dbe8fd; }
        .main-add-button-container { text-align: center; margin-bottom: 25px; }
        .draggable-item.dragging { opacity: 0.4; background: #cce5ff; }
        .drop-target-folder { box-shadow: 0 0 0 2px #007bff !important; background-color: #eef5ff !important; }
        .drop-indicator-line { height: 4px; background-color: #0d6efd; border-radius: 2px; margin: -2px 0; }
        #root-dropzone {
            height: 50px; margin-top: 15px; border-radius: 8px; display: flex;
            align-items: center; justify-content: center; font-size: 0.9em;
            color: #aaa; border: 2px dashed transparent; transition: all 0.2s ease-in-out;
        }
        #root-dropzone.drop-target-root { border-color: #007bff; background-color: #eef5ff; color: #007bff; }
        
        /* --- ä¿®æ”¹é» START (é ‚éƒ¨æ”¾ç½®å€æ¨£å¼) --- */
        .top-dropzone {
            height: 15px;
            margin-bottom: 5px;
            border-radius: 8px;
            transition: all 0.2s ease-in-out;
            display: none; /* å¹³æ™‚éš±è— */
        }
        body.is-dragging .top-dropzone {
            display: block; /* æ‹–æ›³æ™‚é¡¯ç¤º */
        }
        .top-dropzone.drop-target-top {
            background-color: #eef5ff;
            border: 2px dashed #007bff;
            height: 40px; /* è®Šç‚ºç›®æ¨™æ™‚å¢é«˜ï¼Œæ›´å®¹æ˜“æ”¾ç½® */
        }
        /* --- ä¿®æ”¹é» END --- */

        @media (max-width: 600px) {
            body { padding: 10px; }
            .bookmark-container { padding: 15px; border-radius: 8px; }
            h1 { font-size: 1.8em; }
            .bookmark-list ul { padding-left: 20px; }
            .item-controls { opacity: 0; }
            .bookmark-item.touch-hover .item-controls { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="bookmark-container">
        <h1>æˆ‘çš„æ›¸ç±¤</h1>
        <div class="main-add-button-container">
            <button id="add-main-folder-btn" class="add-btn">ï¼‹ æ–°å¢ä¸»è³‡æ–™å¤¾</button>
            <button id="add-main-link-btn" class="add-btn">ï¼‹ æ–°å¢æ›¸ç±¤åˆ°ä¸»é </button>
        </div>
        <ul id="bookmark-list-root" class="bookmark-list"></ul>
        <div id="root-dropzone">æ‹–æ›³åˆ°æ­¤è™•å¯ç§»è‡³æœ€å¤–å±¤</div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const BOOKMARKS_STORAGE_KEY = 'myEditableBookmarks_v5.6';
    const rootListElement = document.getElementById('bookmark-list-root');
    const addMainFolderBtn = document.getElementById('add-main-folder-btn');
    const addMainLinkBtn = document.getElementById('add-main-link-btn');
    const rootDropzone = document.getElementById('root-dropzone');
    let bookmarks = [];

    const initialBookmarks = [
        { "type": "folder", "name": "æ›¸ç±¤åˆ—", "isOpen": true, "children": [
            { "type": "link", "name": "Microsoft Office", "url": "https://www.office.com/?auth=2" },
            { "type": "link", "name": "eHRS(ç·šä¸Šäººè³‡)", "url": "http://cshr.chainsea.com.tw/Ehrsnet/Account/Index#Home" },
            { "type": "folder", "name": "OPPO", "isOpen": false, "children": [
                { "type": "link", "name": "Twilio", "url": "https://flex.twilio.com/lion-bloodhound-6675" },
                { "type": "link", "name": "WCSM", "url": "https://service-sg.myoppo.com/login" },
                { "type": "link", "name": "çµ±ä¸€èªè­‰ä¸­å¿ƒ", "url": "https://sso.myoas.com/siam/login?service=https%3A%2F%2Fsso.myoas.com%2Fsiam%2Foauth2.0%2FcallbackAuthorize%3Foauth20_callbackUrl%3Dhttps%3A%2F%2Fgcsm-sg.oppoit.com%2Fportal%2Fapi%2Fv1%2Fsso%2Fcallback&oauth20_state=https%3A%2F%2Fgcsm-sg.oppoit.com%2Forder%2Forder-management%2Fafter-sales-order" },
                { "type": "link", "name": "é»‘è²“è²¨æ…‹", "url": "https://www.t-cat.com.tw/inquire/trace.aspx" },
            ]}
        ]},
        { "type": "folder", "name": "realme", "isOpen": false, "children": [
            { "type": "link", "name": "æ–°ECP", "url": "https://cs-bpo01.qbicloud.com/ecp/" },
            { "type": "link", "name": "ECP", "url": "https://bpo.qbicloud.com/ecp/Qs.MainFrame.page" },
            { "type": "link", "name": "RCSM", "url": "https://rcsm-sg.realmeservice.com/#/login" },
        ]}
    ];

    // --- è³‡æ–™è™•ç† & æ ¸å¿ƒåŠŸèƒ½ ---
    function loadBookmarks() {
        try {
            const storedBookmarks = localStorage.getItem(BOOKMARKS_STORAGE_KEY);
            // ç°¡åŒ–é è¨­æ›¸ç±¤æ•¸æ“šä»¥ä¾¿æ¸¬è©¦
            bookmarks = storedBookmarks ? JSON.parse(storedBookmarks) : initialBookmarks;
        } catch (e) {
            console.error("ç„¡æ³•è¼‰å…¥æˆ–è§£ææ›¸ç±¤ï¼Œå°‡ä½¿ç”¨é è¨­æ›¸ç±¤:", e);
            bookmarks = initialBookmarks;
        }
    }
    function saveBookmarks() {
        try {
            localStorage.setItem(BOOKMARKS_STORAGE_KEY, JSON.stringify(bookmarks, null, 2));
        } catch (e) {
            console.error("ç„¡æ³•å„²å­˜æ›¸ç±¤:", e);
            alert("ç„¡æ³•å„²å­˜æ›¸ç±¤ï¼Œå¯èƒ½æ˜¯å„²å­˜ç©ºé–“å·²æ»¿ã€‚");
        }
    }
    function getFaviconUrl(url) {
        try {
            return `https://www.google.com/s2/favicons?sz=32&domain_url=${new URL(url).hostname}`;
        } catch (e) {
            return "data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=";
        }
    }
    function getNodeAndParentArray(path) {
        if (!path || path.length === 0) return { node: null, parentArray: bookmarks };
        let parentArray = bookmarks;
        let parentNode = null;
        for (let i = 0; i < path.length - 1; i++) {
            parentNode = parentArray[path[i]];
            if (parentNode?.type === 'folder' && Array.isArray(parentNode.children)) {
                parentArray = parentNode.children;
            } else {
                return { node: null, parentArray: null };
            }
        }
        return { node: parentArray[path[path.length - 1]], parentArray };
    }
    function addItem(path, type) {
        const { node } = getNodeAndParentArray(path);
        const targetArray = path.length === 0 ? bookmarks : (node?.children);
        if (!Array.isArray(targetArray)) {
            console.error("ç„¡æ³•æ–°å¢é …ç›®ï¼šç›®æ¨™ä½ç½®ç„¡æ•ˆ");
            return;
        }
        const name = prompt(`è«‹è¼¸å…¥æ–°çš„${type === 'link' ? 'æ›¸ç±¤' : 'è³‡æ–™å¤¾'}åç¨±ï¼š`);
        if (!name) return;

        if (type === 'link') {
            const url = prompt("è«‹è¼¸å…¥ç¶²å€ (URL)ï¼š", "https://");
            if (!url) return;
            targetArray.push({ type: 'link', name, url });
        } else {
            targetArray.push({ type: 'folder', name, children: [], isOpen: true });
        }
        saveAndRerender();
    }
    function editItem(path) {
        const { node } = getNodeAndParentArray(path);
        if (!node) return;
        const newName = prompt("è«‹è¼¸å…¥æ–°çš„åç¨±ï¼š", node.name);
        if (newName === null) return;
        node.name = newName || node.name;

        if (node.type === 'link') {
            const newUrl = prompt("è«‹è¼¸å…¥æ–°çš„ç¶²å€ï¼š", node.url);
            if (newUrl !== null) node.url = newUrl || node.url;
        }
        saveAndRerender();
    }
    function deleteItem(path) {
        const { node, parentArray } = getNodeAndParentArray(path);
        if (!node || !parentArray) return;
        if (confirm(`ç¢ºå®šè¦åˆªé™¤ "${node.name}" å—ï¼Ÿ`)) {
            const index = path[path.length - 1];
            parentArray.splice(index, 1);
            saveAndRerender();
        }
    }
    function saveAndRerender() { saveBookmarks(); render(); }
    
    // --- æ¸²æŸ“ç•«é¢ ---
    function render() {
        rootListElement.innerHTML = '';
        renderNodes(bookmarks, rootListElement, []);
    }
    function renderNodes(nodes, parentElement, path) {
        // --- ä¿®æ”¹é» START (æ–°å¢é ‚éƒ¨æ”¾ç½®å€) ---
        const topDropzone = document.createElement('li');
        topDropzone.className = 'top-dropzone';
        // å°‡çˆ¶å±¤è·¯å¾‘å­˜å„²èµ·ä¾†ï¼Œæ–¹ä¾¿æ”¾ç½®æ™‚è¨ˆç®—ç›®æ¨™è·¯å¾‘
        topDropzone.dataset.parentPath = JSON.stringify(path);
        parentElement.appendChild(topDropzone);
        // --- ä¿®æ”¹é» END ---

        nodes.forEach((node, index) => {
            const currentPath = [...path, index];
            const li = document.createElement('li');
            li.className = 'bookmark-item draggable-item';
            li.dataset.path = JSON.stringify(currentPath);
            li.draggable = true;
            if (node.type === 'folder') {
                li.appendChild(createFolderElement(node, currentPath));
            } else {
                li.appendChild(createLinkElement(node, currentPath));
            }
            parentElement.appendChild(li);
        });
    }
    function createFolderElement(node, path) {
        const details = document.createElement('details');
        details.className = 'bookmark-folder-details';
        details.open = !!node.isOpen;
        details.addEventListener('toggle', () => { node.isOpen = details.open; saveBookmarks(); });
        const summary = document.createElement('summary');
        summary.className = 'bookmark-folder-summary';
        const h3 = document.createElement('h3');
        h3.textContent = node.name;
        summary.append(h3, createControls(path));
        const ul = document.createElement('ul');
        ul.className = 'bookmark-list';
        if (node.children) renderNodes(node.children, ul, path);
        details.append(summary, ul, createFolderActions(path));
        return details;
    }
    function createLinkElement(node, path) {
        const a = document.createElement('a');
        a.href = node.url;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.className = 'bookmark-link';
        const img = document.createElement('img');
        img.src = getFaviconUrl(node.url);
        img.alt = '';
        img.className = 'bookmark-icon';
        img.onerror = function() { this.src = "data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs="; };
        a.append(img, document.createTextNode(` ${node.name}`), createControls(path));
        return a;
    }
    function createControls(path) {
        const controlsDiv = document.createElement('div');
        controlsDiv.className = 'item-controls';
        const editBtn = document.createElement('button');
        editBtn.className = 'control-btn';
        editBtn.innerHTML = 'âœ';
        editBtn.title = 'ç·¨è¼¯';
        editBtn.onclick = (e) => { e.preventDefault(); e.stopPropagation(); editItem(path); };
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'control-btn';
        deleteBtn.innerHTML = 'ğŸ—‘ï¸';
        deleteBtn.title = 'åˆªé™¤';
        deleteBtn.onclick = (e) => { e.preventDefault(); e.stopPropagation(); deleteItem(path); };
        controlsDiv.append(editBtn, deleteBtn);
        return controlsDiv;
    }
    function createFolderActions(path) {
        const folderActions = document.createElement('div');
        folderActions.className = 'folder-actions';
        const addLinkBtn = document.createElement('button');
        addLinkBtn.textContent = 'ï¼‹ æ–°å¢æ›¸ç±¤';
        addLinkBtn.className = 'add-btn';
        addLinkBtn.onclick = (e) => { e.preventDefault(); addItem(path, 'link'); };
        const addSubFolderBtn = document.createElement('button');
        addSubFolderBtn.textContent = 'ï¼‹ æ–°å¢å­è³‡æ–™å¤¾';
        addSubFolderBtn.className = 'add-btn';
        addSubFolderBtn.onclick = (e) => { e.preventDefault(); addItem(path, 'folder'); };
        folderActions.append(addLinkBtn, addSubFolderBtn);
        return folderActions;
    }

    // --- æ‹–æ›³é‚è¼¯ ---
    let draggedElementPath = null;
    let scrollInterval = null;
    let lastClientY = 0;
    const SCROLL_ZONE_SIZE = 60;
    const SCROLL_SPEED = 15;
    let openFolderTimer = null;
    let longPressTimer = null;
    let touchStartEvent = null;
    let isDragging = false;
    
    function autoScroll() {
        if (!isDragging) return;
        if (lastClientY < SCROLL_ZONE_SIZE) window.scrollBy(0, -SCROLL_SPEED);
        else if (lastClientY > window.innerHeight - SCROLL_ZONE_SIZE) window.scrollBy(0, SCROLL_SPEED);
    }
    
    function startDrag(targetElement, event) {
        if (!targetElement) return;
        isDragging = true;
        document.body.classList.add('is-dragging'); // ç‚º body æ–°å¢ class ä»¥é¡¯ç¤ºæ”¾ç½®å€

        draggedElementPath = JSON.parse(targetElement.dataset.path);
        
        if (event && event.dataTransfer) {
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', null);
        }
        setTimeout(() => targetElement.classList.add('dragging'), 0);
        if (!scrollInterval) scrollInterval = setInterval(autoScroll, 100);
        clearTouchHover();
    }
    
    let currentIndicator = null;
    function clearIndicators() {
        currentIndicator?.remove();
        currentIndicator = null;
        document.querySelectorAll('.drop-target-folder, .drop-target-root, .drop-target-top').forEach(el => 
            el.classList.remove('drop-target-folder', 'drop-target-root', 'drop-target-top')
        );
        clearTimeout(openFolderTimer);
    }

    function handleMove(e) {
        if (e.type === 'touchmove' && isDragging) {
            e.preventDefault({ passive: false });
        }
        if (e.type === 'dragover') { e.preventDefault(); }
        if (!isDragging) return;

        const clientY = e.type.startsWith('touch') ? e.touches[0].clientY : e.clientY;
        const clientX = e.type.startsWith('touch') ? e.touches[0].clientX : e.clientX;
        lastClientY = clientY;
        
        clearIndicators();

        const dropTargetElement = document.elementFromPoint(clientX, clientY);
        if (!dropTargetElement) return;
        
        // --- ä¿®æ”¹é» START (å¢åŠ é ‚éƒ¨/è³‡æ–™å¤¾/é …ç›®ä¹‹é–“çš„åˆ¤æ–·é †åº) ---
        // åˆ¤æ–·é †åº 1ï¼šæ˜¯å¦æƒ³æ”¾å…¥åˆ—è¡¨é ‚éƒ¨ï¼Ÿ
        const topDropzone = dropTargetElement.closest('.top-dropzone');
        if(topDropzone) {
            topDropzone.classList.add('drop-target-top');
            return; // æ‰¾åˆ°ç›®æ¨™ï¼ŒçµæŸåˆ¤æ–·
        }

        // åˆ¤æ–·é †åº 2ï¼šæ˜¯å¦æƒ³æ”¾å…¥è³‡æ–™å¤¾ï¼Ÿ
        const folderSummary = dropTargetElement.closest('.bookmark-folder-summary');
        if (folderSummary) {
            const folderItem = folderSummary.closest('.draggable-item');
            const folderPathStr = folderItem?.dataset.path;
            const draggedPathStr = JSON.stringify(draggedElementPath);
            const isDroppingOnItselfOrChild = folderPathStr === draggedPathStr || (folderPathStr && draggedPathStr.startsWith(folderPathStr.slice(0, -1) + ','));

            if (folderPathStr && !isDroppingOnItselfOrChild) {
                const folderDetails = folderSummary.closest('.bookmark-folder-details');
                folderDetails.classList.add('drop-target-folder');
                if (!folderDetails.open) {
                    openFolderTimer = setTimeout(() => { if (folderDetails) folderDetails.open = true; }, 600);
                }
                return; // æ‰¾åˆ°ç›®æ¨™ï¼ŒçµæŸåˆ¤æ–·
            }
        }

        // åˆ¤æ–·é †åº 3ï¼šæ˜¯å¦æƒ³æ”¾åœ¨é …ç›®ä¹‹é–“ï¼Ÿ
        const dropTargetItem = dropTargetElement.closest('.draggable-item');
        if (dropTargetItem && dropTargetItem.dataset.path !== JSON.stringify(draggedElementPath)) {
            const rect = dropTargetItem.getBoundingClientRect();
            const indicator = document.createElement('div');
            indicator.className = 'drop-indicator-line';
            currentIndicator = indicator;
            const dropPosition = (clientY - rect.top) / rect.height;
            if (dropPosition < 0.5) {
                dropTargetItem.before(indicator);
            } else {
                dropTargetItem.after(indicator);
            }
            return; // æ‰¾åˆ°ç›®æ¨™ï¼ŒçµæŸåˆ¤æ–·
        }

        // åˆ¤æ–·é †åº 4ï¼šæ˜¯å¦æƒ³æ”¾å…¥æ ¹ç›®éŒ„åº•éƒ¨ï¼Ÿ
        const dropTargetRoot = dropTargetElement.closest('#root-dropzone');
        if (dropTargetRoot) {
            dropTargetRoot.classList.add('drop-target-root');
        }
        // --- ä¿®æ”¹é» END ---
    }
    
    function endDrag(e) {
        if (!isDragging) return;
        if (e.type === 'touchend') e.preventDefault();
        
        const dropTargetTop = document.querySelector('.drop-target-top');
        const dropTargetRoot = document.querySelector('.drop-target-root');
        const dropTargetFolder = document.querySelector('.drop-target-folder');
        const dropIndicator = document.querySelector('.drop-indicator-line');
        let destinationPath;

        // --- ä¿®æ”¹é» START (å¢åŠ å°é ‚éƒ¨æ”¾ç½®å€çš„è™•ç†) ---
        if (dropTargetTop) {
            const parentPath = JSON.parse(dropTargetTop.dataset.parentPath);
            destinationPath = [...parentPath, 0];
        } else if (dropTargetRoot) {
        // --- ä¿®æ”¹é» END ---
            destinationPath = [bookmarks.length];
        } else if (dropTargetFolder) {
            const pathStr = dropTargetFolder.closest('.draggable-item')?.dataset.path;
            if (pathStr) {
                const path = JSON.parse(pathStr);
                const { node } = getNodeAndParentArray(path);
                if (node?.type === 'folder' && Array.isArray(node.children)) {
                    destinationPath = [...path, node.children.length];
                }
            }
        } else if (dropIndicator) {
            const prev = dropIndicator.previousElementSibling;
            const next = dropIndicator.nextElementSibling;
            if (next?.matches('.draggable-item')) {
                destinationPath = JSON.parse(next.dataset.path);
            } else if (prev?.matches('.draggable-item')) {
                const path = JSON.parse(prev.dataset.path);
                path[path.length - 1]++;
                destinationPath = path;
            } else {
                const parentUl = dropIndicator.parentElement;
                const parentItem = parentUl.closest('.draggable-item');
                if (parentItem) {
                    const parentPath = JSON.parse(parentItem.dataset.path);
                    destinationPath = [...parentPath, 0];
                } else {
                    destinationPath = [0];
                }
            }
        }

        if (draggedElementPath && destinationPath) {
            moveNode(draggedElementPath, destinationPath);
            saveAndRerender();
        }
        stopDragAndClear();
    }

    function stopDragAndClear() {
        clearInterval(scrollInterval);
        scrollInterval = null;
        clearIndicators();
        document.querySelector('.dragging')?.classList.remove('dragging');
        document.body.classList.remove('is-dragging'); // ç§»é™¤ body çš„ class
        draggedElementPath = null;
        isDragging = false;
        clearTimeout(longPressTimer);
        longPressTimer = null;
        touchStartEvent = null;
    }

    function moveNode(sourcePath, destinationPath) {
        const sourcePathStr = JSON.stringify(sourcePath);
        const destPathStr = JSON.stringify(destinationPath);
        if (sourcePathStr === destPathStr || (destPathStr && sourcePathStr && destPathStr.startsWith(sourcePathStr.slice(0, -1) + ','))) return;

        const { node: nodeToMove, parentArray: sourceParentArray } = getNodeAndParentArray(sourcePath);
        if (!nodeToMove || !sourceParentArray) return;
        const sourceIndex = sourcePath[sourcePath.length - 1];
        const [removedItem] = sourceParentArray.splice(sourceIndex, 1);

        let adjustedDestPath = [...destinationPath];
        const sourceParentPathStr = JSON.stringify(sourcePath.slice(0, -1));
        const destParentPathStr = JSON.stringify(destinationPath.slice(0, -1));

        if (sourceParentPathStr === destParentPathStr && sourceIndex < destinationPath[destinationPath.length - 1]) {
            adjustedDestPath[adjustedDestPath.length - 1]--;
        }
        
        const destParentPath = adjustedDestPath.slice(0, -1);
        let destArray;
        if (destParentPath.length === 0) {
            destArray = bookmarks;
        } else {
            const { node: destParentNode } = getNodeAndParentArray(destParentPath);
            if (destParentNode && destParentNode.type === 'folder') {
                destArray = destParentNode.children;
            }
        }
        
        if (destArray) {
            const destIndex = adjustedDestPath[adjustedDestPath.length - 1];
            destArray.splice(destIndex, 0, removedItem);
        } else {
            console.error("ç„¡æ³•æ‰¾åˆ°æœ‰æ•ˆçš„ç›®æ¨™ä½ç½®ï¼Œç§»å‹•æ“ä½œå·²å–æ¶ˆã€‚");
            sourceParentArray.splice(sourceIndex, 0, removedItem);
        }
    }
    
    function handleTouchStart(e) {
        if (e.target.closest('.control-btn, .add-btn, a[href]')) return;
        
        const target = e.target.closest('.draggable-item');
        if (!target) return;

        touchStartEvent = e;
        longPressTimer = setTimeout(() => {
            if(touchStartEvent) {
                // --- ä¿®æ”¹é» START (é˜²æ­¢é•·æŒ‰é¸å–®) ---
                // åœ¨ç¢ºèªç‚ºé•·æŒ‰å¾Œï¼Œé˜»æ­¢ç€è¦½å™¨é è¨­è¡Œç‚º (å¦‚å½ˆå‡ºé¸å–®)
                touchStartEvent.preventDefault({ passive: false });
                // --- ä¿®æ”¹é» END ---

                if (navigator.vibrate) navigator.vibrate(50);
                startDrag(target, null); 
            }
        }, 350);
    }

    function handleTouchMove(e) {
        if (isDragging) {
            handleMove(e);
            return;
        }
        
        if (touchStartEvent) {
            const touch = e.touches[0];
            const startTouch = touchStartEvent.touches[0];
            if (Math.abs(touch.clientX - startTouch.clientX) > 10 || Math.abs(touch.clientY - startTouch.clientY) > 10) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
                touchStartEvent = null;
            }
        }
    }

    function handleTouchEnd(e) {
        if (longPressTimer) {
            clearTimeout(longPressTimer);
            if (!isDragging) {
                 handleTap(e);
            }
        }
        endDrag(e);
    }
    
    function clearTouchHover(exceptElement = null) {
        document.querySelectorAll('.touch-hover').forEach(el => {
            if (el !== exceptElement) {
                el.classList.remove('touch-hover');
            }
        });
    }

    function handleTap(e) {
        const targetItem = e.target.closest('.bookmark-item');
        if (!targetItem) {
            clearTouchHover();
            return;
        }

        const link = e.target.closest('a.bookmark-link');
        const summary = e.target.closest('summary.bookmark-folder-summary');

        if (link && !targetItem.classList.contains('touch-hover')) {
             // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡é»æ“Šé€£çµï¼Œä¸¦ä¸”æ²’æœ‰ hover æ•ˆæœï¼Œå°±æ¨¡æ“¬ hover
             clearTouchHover();
             targetItem.classList.add('touch-hover');
             e.preventDefault(); // é˜»æ­¢ç¬¬ä¸€æ¬¡é»æ“Šç›´æ¥è·³è½‰ï¼Œè®“ç”¨æˆ¶æœ‰æ©Ÿæœƒé»æ“Šç·¨è¼¯/åˆªé™¤
             return;
        }
        
        if(summary) {
            // é»æ“Š summary å€åŸŸï¼Œåˆ‡æ› hover ç‹€æ…‹
            if (targetItem.classList.contains('touch-hover')) {
                if(!e.target.closest('.item-controls')) {
                   setTimeout(() => clearTouchHover(), 100);
                }
            } else {
                clearTouchHover();
                targetItem.classList.add('touch-hover');
            }
            return;
        }

        // å¦‚æœå·²ç¶“æ˜¯ hover ç‹€æ…‹ï¼Œä¸”ä¸æ˜¯é»æ“Šæ§åˆ¶æŒ‰éˆ•ï¼Œå‰‡å–æ¶ˆ hover
        if (targetItem.classList.contains('touch-hover') && !e.target.closest('.item-controls')) {
            setTimeout(() => clearTouchHover(), 100); 
        }
    }
    
    // --- ç¶å®šäº‹ä»¶ ---
    document.addEventListener('dragstart', (e) => {
        const target = e.target.closest('.draggable-item');
        if (target) startDrag(target, e);
    });
    document.addEventListener('dragover', handleMove);
    document.addEventListener('drop', endDrag);
    document.addEventListener('dragend', stopDragAndClear);
    
    document.addEventListener('touchstart', handleTouchStart, { passive: false });
    document.addEventListener('touchmove', handleTouchMove, { passive: false });
    document.addEventListener('touchend', handleTouchEnd);
    document.addEventListener('touchcancel', stopDragAndClear);

    // --- ä¿®æ”¹é» START (é˜²æ­¢é•·æŒ‰é¸å–®çš„å¦ä¸€ç¨®æ–¹å¼) ---
    // ç›£è½ contextmenu äº‹ä»¶ä¸¦é˜»æ­¢å®ƒï¼Œé€™æ˜¯æ¡Œé¢å³éµå’Œè¡Œå‹•é•·æŒ‰çš„æ¨™æº–äº‹ä»¶
    document.addEventListener('contextmenu', (e) => {
        // åªåœ¨å¯æ‹–æ›³çš„é …ç›®ä¸Šé˜»æ­¢ï¼Œé¿å…å½±éŸ¿é é¢å…¶ä»–åœ°æ–¹çš„æ­£å¸¸åŠŸèƒ½
        if (e.target.closest('.draggable-item')) {
            e.preventDefault();
        }
    });
    // --- ä¿®æ”¹é» END ---

    document.addEventListener('click', (e) => {
        if (!e.target.closest('.bookmark-item')) {
            clearTouchHover();
        }
    }, true); // ä½¿ç”¨æ•ç²éšæ®µç¢ºä¿èƒ½è™•ç†

    // --- åˆå§‹åŒ– ---
    addMainFolderBtn.addEventListener('click', () => addItem([], 'folder'));
    addMainLinkBtn.addEventListener('click', () => addItem([], 'link'));
    loadBookmarks();
    render();
});
</script>

</body>
</html>
